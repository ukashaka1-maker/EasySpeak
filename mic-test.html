<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microphone Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        button {
            width: 100%;
            padding: 20px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        button:hover {
            transform: scale(1.02);
        }
        .meter {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            width: 0%;
            transition: width 0.1s;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        .success {
            background: #43e97b;
            color: white;
        }
        .error {
            background: #f5576c;
            color: white;
        }
        .info {
            background: #667eea;
            color: white;
        }
        #log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Microphone Test</h1>
        <p>This will test if your microphone actually works</p>

        <button onclick="testMicrophone()">üé§ Start Microphone Test</button>
        <button onclick="testSpeechRecognition()">üó£Ô∏è Test Speech Recognition</button>

        <div class="meter">
            <div class="meter-fill" id="meterFill"></div>
        </div>

        <div id="status"></div>
        <div id="log"></div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let stream;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'black'}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        async function testMicrophone() {
            log('=== MICROPHONE TEST START ===');
            
            try {
                // Request microphone access
                log('Requesting microphone access...');
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                log('‚úÖ Microphone access granted!', 'success');
                showStatus('‚úÖ Microphone connected! Speak now...', 'success');

                // Get microphone info
                const tracks = stream.getAudioTracks();
                log(`Microphone: ${tracks[0].label}`);
                log(`Settings: ${JSON.stringify(tracks[0].getSettings())}`);

                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);
                
                log('Audio analysis started. SPEAK NOW!');
                
                let maxVolume = 0;
                let volumeReadings = [];

                // Monitor volume for 10 seconds
                const interval = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    
                    // Calculate average volume
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;
                    volumeReadings.push(average);
                    
                    if (average > maxVolume) maxVolume = average;
                    
                    // Update meter
                    const percent = Math.min(100, (average / 128) * 100);
                    document.getElementById('meterFill').style.width = percent + '%';
                    
                    // Log significant changes
                    if (average > 5) {
                        log(`üîä Volume: ${Math.round(average)} (max: ${Math.round(maxVolume)})`);
                    }
                    
                    // Check if hearing anything
                    if (average > 20) {
                        showStatus('‚úÖ HEARING YOU! Keep talking...', 'success');
                    } else if (average > 5) {
                        showStatus('‚ö†Ô∏è Hearing something but too quiet. SPEAK LOUDER!', 'info');
                    }
                }, 100);

                // Stop after 10 seconds
                setTimeout(() => {
                    clearInterval(interval);
                    stream.getTracks().forEach(track => track.stop());
                    
                    log('=== TEST COMPLETE ===');
                    log(`Max volume recorded: ${Math.round(maxVolume)}`);
                    log(`Average volume: ${Math.round(volumeReadings.reduce((a,b) => a+b) / volumeReadings.length)}`);
                    
                    if (maxVolume < 5) {
                        showStatus('‚ùå NO SOUND DETECTED! Microphone may be muted or broken.', 'error');
                        log('‚ùå PROBLEM: No audio detected. Check if microphone is muted!', 'error');
                    } else if (maxVolume < 20) {
                        showStatus('‚ö†Ô∏è Sound detected but VERY QUIET. Increase volume or speak louder!', 'error');
                        log('‚ö†Ô∏è WARNING: Audio too quiet for speech recognition', 'error');
                    } else {
                        showStatus('‚úÖ Microphone works! Volume is good.', 'success');
                        log('‚úÖ SUCCESS: Microphone is working properly!', 'success');
                    }
                }, 10000);

            } catch (error) {
                log(`‚ùå ERROR: ${error.name} - ${error.message}`, 'error');
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('Microphone permission denied. Please allow microphone access.', 'error');
                } else if (error.name === 'NotFoundError') {
                    log('No microphone found. Please connect a microphone.', 'error');
                }
            }
        }

        async function testSpeechRecognition() {
            log('=== SPEECH RECOGNITION TEST START ===');

            if (!('webkitSpeechRecognition' in window)) {
                log('‚ùå Speech Recognition not supported in this browser', 'error');
                showStatus('‚ùå Speech Recognition not supported. Use Chrome/Edge.', 'error');
                return;
            }

            try {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = true;
                recognition.interimResults = true;

                log('Starting speech recognition...');
                showStatus('üé§ Listening for speech... SPEAK NOW IN ENGLISH!', 'info');

                recognition.onstart = function() {
                    log('‚úÖ Recognition started');
                };

                recognition.onaudiostart = function() {
                    log('‚úÖ Audio capture started');
                };

                recognition.onsoundstart = function() {
                    log('‚úÖ Sound detected!');
                };

                recognition.onspeechstart = function() {
                    log('‚úÖ SPEECH DETECTED!', 'success');
                    showStatus('‚úÖ I hear you speaking!', 'success');
                };

                recognition.onresult = function(event) {
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        const confidence = event.results[i][0].confidence;
                        const isFinal = event.results[i].isFinal;
                        
                        log(`${isFinal ? '‚úÖ FINAL' : '‚è≥ Interim'}: "${transcript}" (confidence: ${Math.round(confidence * 100)}%)`);
                        showStatus(`Heard: "${transcript}"`, 'success');
                    }
                };

                recognition.onspeechend = function() {
                    log('Speech ended');
                };

                recognition.onsoundend = function() {
                    log('Sound ended');
                };

                recognition.onaudioend = function() {
                    log('Audio capture ended');
                };

                recognition.onerror = function(event) {
                    log(`‚ùå ERROR: ${event.error} - ${event.message || 'No message'}`, 'error');
                    showStatus(`‚ùå Error: ${event.error}`, 'error');
                    
                    switch(event.error) {
                        case 'no-speech':
                            log('PROBLEM: API did not detect speech. Possible reasons:', 'error');
                            log('1. Microphone volume too low', 'error');
                            log('2. Speaking too quietly', 'error');
                            log('3. Not speaking in English', 'error');
                            log('4. Ambient noise too high', 'error');
                            break;
                        case 'audio-capture':
                            log('PROBLEM: Cannot capture audio from microphone', 'error');
                            break;
                        case 'not-allowed':
                            log('PROBLEM: Microphone permission denied', 'error');
                            break;
                    }
                };

                recognition.onend = function() {
                    log('Recognition ended');
                    log('=== TEST COMPLETE ===');
                };

                recognition.start();

                // Stop after 10 seconds
                setTimeout(() => {
                    try {
                        recognition.stop();
                    } catch (e) {
                        log('Recognition already stopped');
                    }
                }, 10000);

            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`, 'error');
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
